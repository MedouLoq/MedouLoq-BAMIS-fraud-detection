{% extends 'base/base.html' %}
{% load static %}

{% block title %}Transaction {{ transaction.trx }} - BAMIS Fraud Detection{% endblock %}

{% block extra_css %}
<style>
    .custom-alert {
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
    font-size: 0.95rem;
    background-color: #f8f9fa; /* Light default, gets overridden by alert-* */
    color: #212529;
}
.custom-alert.alert-warning {
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
    font-size: 0.95rem;
    background-color: #fff3cd; /* Warning yellow */
    color: #856404;
    border: 1px solid #ffeaa7;
}

.custom-alert.alert-danger {
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
    font-size: 0.95rem;
    background-color: #f8d7da; /* Danger red */
    color: #721c24;
    border: 1px solid #f5c6cb;
}
    .transaction-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    
    .transaction-header.fraud {
        background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
    }
    
    .transaction-header.warning {
        background: linear-gradient(135deg, #fd7e14 0%, #ff8c42 100%);
    }
    
    .detail-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        border-left: 4px solid #28a745;
    }
    
    .detail-card.fraud {
        border-left-color: #dc3545;
    }
    
    .detail-card.warning {
        border-left-color: #fd7e14;
    }
    
    .flow-diagram {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 12px;
        margin: 1rem 0;
    }
    
    .flow-item {
        text-align: center;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-width: 150px;
    }
    
    .flow-arrow {
        margin: 0 1rem;
        font-size: 1.5rem;
        color: #28a745;
    }
    
    .risk-meter {
        position: relative;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .risk-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }
    
    .similar-transaction {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .similar-transaction:hover {
        border-color: #28a745;
        transform: translateX(5px);
    }
    
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        background: #28a745;
        border-radius: 50%;
    }
    
    .timeline-item.fraud::before {
        background: #dc3545;
    }
    
    .feature-importance {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .feature-bar {
        flex: 1;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        margin: 0 1rem;
        overflow: hidden;
    }
    
    .feature-fill {
        height: 100%;
        background: #28a745;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Transaction Header -->
    <div class="transaction-header {% if transaction.ml_is_fraud %}fraud{% elif transaction.claude_priority_level == 'HIGH' %}warning{% endif %}">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-exchange-alt"></i> Transaction {{ transaction.trx }}
                </h1>
                <p class="mb-0 opacity-75">
                    {{ transaction.uploaded_at|date:"d/m/Y à H:i:s" }} • 
                    {{ transaction.get_trx_type_display }} • 
                    {{ transaction.get_etat_display }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="d-flex flex-column align-items-md-end">
                    {% if transaction.ml_is_fraud %}
                        <span class="badge bg-light text-dark fs-5 mb-2">
                            <i class="fas fa-exclamation-triangle"></i> FRAUDE DÉTECTÉE
                        </span>
                    {% else %}
                        <span class="badge bg-light text-dark fs-5 mb-2">
                            <i class="fas fa-check-circle"></i> TRANSACTION LÉGITIME
                        </span>
                    {% endif %}
                    <h2 class="mb-0">{{ transaction.formatted_amount }}</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Transaction Flow -->
            <div class="detail-card {% if transaction.ml_is_fraud %}fraud{% endif %}">
                <h5 class="mb-3">
                    <i class="fas fa-route text-primary"></i> 
                    Flux de Transaction
                </h5>
                
                <div class="flow-diagram">
                    <div class="flow-item">
                        <i class="fas fa-user fa-2x text-primary mb-2"></i>
                        <h6>{{ transaction.client_i }}</h6>
                        <small class="text-muted">Client Source</small>
                        <div class="mt-2">
                            <span class="badge bg-secondary">{{ transaction.bank_i }}</span>
                        </div>
                    </div>
                    
                    <div class="flow-arrow">
                        {% if transaction.is_self_transfer %}
                            <i class="fas fa-sync-alt text-warning"></i>
                        {% else %}
                            <i class="fas fa-arrow-right"></i>
                        {% endif %}
                    </div>
                    
                    <div class="flow-item">
                        <i class="fas fa-user fa-2x text-success mb-2"></i>
                        <h6>{{ transaction.client_b }}</h6>
                        <small class="text-muted">Client Destination</small>
                        <div class="mt-2">
                            <span class="badge bg-secondary">{{ transaction.bank_b }}</span>
                        </div>
                    </div>
                </div>
                
                {% if transaction.is_self_transfer %}
                <div class="custom-alert alert-warning border-0 mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Auto-transfert détecté</strong> - Cette transaction est effectuée entre les comptes du même client.
                </div>
                {% endif %}
            </div>

            <!-- Transaction Details -->
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="fas fa-info-circle text-primary"></i> 
                    Détails de la Transaction
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="text-muted">ID Transaction:</td>
                                <td><strong>{{ transaction.trx }}</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Type:</td>
                                <td><span class="badge bg-primary">{{ transaction.get_trx_type_display }}</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Montant:</td>
                                <td><strong class="text-success">{{ transaction.formatted_amount }}</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">État:</td>
                                <td>
                                    {% if transaction.etat == 'OK' %}
                                        <span class="badge bg-success">{{ transaction.get_etat_display }}</span>
                                    {% elif transaction.etat == 'KO' %}
                                        <span class="badge bg-danger">{{ transaction.get_etat_display }}</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ transaction.get_etat_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="text-muted">Heure:</td>
                                <td>{{ transaction.trx_time }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Milliseconds:</td>
                                <td>{{ transaction.mls }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Uploadé par:</td>
                                <td>{{ transaction.uploaded_by.username }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Uploadé le:</td>
                                <td>{{ transaction.uploaded_at|date:"d/m/Y H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ML Analysis -->
            {% if transaction.ml_processed_at %}
            <div class="detail-card {% if transaction.ml_is_fraud %}fraud{% endif %}">
                <h5 class="mb-3">
                    <i class="fas fa-robot text-primary"></i> 
                    Analyse Machine Learning
                </h5>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label small text-muted">SCORE DE RISQUE</label>
                        <div class="risk-meter">
                            <div class="risk-fill" style="width: {{ transaction.ml_risk_score|default:0|floatformat:0 }}%; background: {% if transaction.ml_risk_score > 0.7 %}#dc3545{% elif transaction.ml_risk_score > 0.4 %}#fd7e14{% else %}#28a745{% endif %};"></div>
                        </div>
                        <small class="text-muted">{{ transaction.ml_risk_score|default:0|floatformat:2 }}/1.0</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted">CONFIANCE</label>
                        <div class="risk-meter">
                            <div class="risk-fill" style="width: {{ transaction.ml_confidence|default:0|floatformat:0 }}%; background: #28a745;"></div>
                        </div>
                        <small class="text-muted">{{ transaction.ml_confidence|default:0|floatformat:2 }}/1.0</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted">RÉSULTAT</label>
                        <div>
                            {% if transaction.ml_is_fraud %}
                                <span class="badge bg-danger fs-6">FRAUDE</span>
                            {% else %}
                                <span class="badge bg-success fs-6">LÉGITIME</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% if transaction.ml_feature_importance %}
                <div>
                    <label class="form-label small text-muted">IMPORTANCE DES CARACTÉRISTIQUES</label>
                    {% for feature, importance in transaction.ml_feature_importance.items %}
                    <div class="feature-importance">
                        <span style="min-width: 120px;">{{ feature|title }}</span>
                        <div class="feature-bar">
                            <div class="feature-fill" style="width: {{ importance|floatformat:0 }}%;"></div>
                        </div>
                        <span class="text-muted">{{ importance|floatformat:2 }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <small class="text-muted">
                    <i class="fas fa-clock"></i> 
                    Analysé le {{ transaction.ml_processed_at|date:"d/m/Y à H:i" }}
                </small>
            </div>
            {% endif %}

            <!-- Claude Analysis -->
            {% if transaction.claude_explanation %}
            <div class="detail-card {% if transaction.claude_priority_level == 'URGENT' %}fraud{% elif transaction.claude_priority_level == 'HIGH' %}warning{% endif %}">
                <h5 class="mb-3">
                    <i class="fas fa-brain text-primary"></i> 
                    Analyse IA (Claude)
                </h5>
                
<div class="custom-alert alert-{{ transaction.risk_level_class }} border-0 mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>Niveau de Priorité:</strong>
                        <span class="badge bg-{{ transaction.risk_level_class }}">
                            {{ transaction.get_claude_priority_level_display }}
                        </span>
                    </div>
                    <p class="mb-0">{{ transaction.claude_explanation }}</p>
                </div>
                
                {% if transaction.claude_risk_factors %}
                <div class="mb-3">
                    <label class="form-label small text-muted">FACTEURS DE RISQUE IDENTIFIÉS</label>
                    <div>
                        {% for factor in transaction.claude_risk_factors %}
                        <span class="badge bg-warning me-1 mb-1">{{ factor }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> 
                        Analysé le {{ transaction.claude_analyzed_at|date:"d/m/Y à H:i" }}
                    </small>
                    <button class="btn btn-sm btn-outline-primary" onclick="reanalyzeTransaction()">
                        <i class="fas fa-redo"></i> Réanalyser
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Similar Transactions -->
            {% if similar_transactions %}
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="fas fa-search text-primary"></i> 
                    Transactions Similaires
                </h5>
                
                {% for similar in similar_transactions %}
                <div class="similar-transaction">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <strong>{{ similar.trx }}</strong><br>
                            <small class="text-muted">{{ similar.uploaded_at|date:"d/m/Y" }}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-secondary">{{ similar.get_trx_type_display }}</span>
                        </div>
                        <div class="col-md-2">
                            <strong>{{ similar.formatted_amount }}</strong>
                        </div>
                        <div class="col-md-3">
                            {{ similar.client_i }} → {{ similar.client_b }}
                        </div>
                        <div class="col-md-2 text-end">
                            {% if similar.ml_is_fraud %}
                                <span class="badge bg-danger">FRAUDE</span>
                            {% else %}
                                <span class="badge bg-success">OK</span>
                            {% endif %}
                            <a href="{% url 'transaction_detail' similar.id %}" class="btn btn-sm btn-outline-primary ms-1">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Client Information -->
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="fas fa-users text-primary"></i> 
                    Informations Clients
                </h5>
                
                <!-- Source Client -->
                <div class="mb-3">
                    <label class="form-label small text-muted">CLIENT SOURCE</label>
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ transaction.client_i }}</strong>
                        <a href="{% url 'client_detail' transaction.client_i %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                    {% if client_stats.0 %}
                    <small class="text-muted">
                        {{ client_stats.0.total_transactions }} transactions • 
                        {{ client_stats.0.fraud_rate|floatformat:1 }}% fraude
                    </small>
                    {% endif %}
                </div>
                
                <!-- Destination Client -->
                {% if not transaction.is_self_transfer %}
                <div class="mb-3">
                    <label class="form-label small text-muted">CLIENT DESTINATION</label>
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ transaction.client_b }}</strong>
                        <a href="{% url 'client_detail' transaction.client_b %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                    {% if client_stats.1 %}
                    <small class="text-muted">
                        {{ client_stats.1.total_transactions }} transactions • 
                        {{ client_stats.1.fraud_rate|floatformat:1 }}% fraude
                    </small>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Investigation Notes -->
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="fas fa-sticky-note text-primary"></i> 
                    Notes d'Investigation
                </h5>
                
                <form id="noteForm" onsubmit="addNote(event)">
                    <div class="mb-3">
                        <textarea class="form-control" id="noteText" rows="3" placeholder="Ajouter une note d'investigation..."></textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="flagTransaction">
                            <label class="form-check-label" for="flagTransaction">
                                Signaler pour investigation
                            </label>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                </form>
                
                <div id="notesList" class="mt-3">
                    {% for note in transaction.notes.all %}
                    <div class="timeline-item {% if note.is_flagged %}fraud{% endif %}">
                        <div class="d-flex justify-content-between">
                            <strong>{{ note.author.username }}</strong>
                            <small class="text-muted">{{ note.created_at|date:"d/m H:i" }}</small>
                        </div>
                        <p class="mb-1">{{ note.note }}</p>
                        {% if note.is_flagged %}
                        <span class="badge bg-warning">Signalé</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-3">Aucune note d'investigation</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="fas fa-tools text-primary"></i> 
                    Actions Rapides
                </h5>
                <div class="d-grid gap-2">
                    {% if not transaction.claude_explanation %}
                    <button class="btn btn-outline-primary" onclick="analyzeWithClaude()">
                        <i class="fas fa-brain"></i> Analyser avec IA
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-info" onclick="exportTransaction()">
                        <i class="fas fa-download"></i> Exporter Données
                    </button>
                    <button class="btn btn-outline-warning" onclick="blockTransaction()">
                        <i class="fas fa-ban"></i> Bloquer Transaction
                    </button>
                    <button class="btn btn-outline-success" onclick="approveTransaction()">
                        <i class="fas fa-check"></i> Approuver
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function reanalyzeTransaction() {
    if (confirm('Relancer l\'analyse IA pour cette transaction ?')) {
        showAlert('Analyse en cours...', 'info');
        fetch(`/api/transactions/{{ transaction.id }}/analyze/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Analyse terminée', 'success');
                // Mettre à jour le contenu sans recharger la page
                updateClaudeAnalysis(data);
            } else {
                showAlert('Erreur: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Erreur de connexion', 'danger');
        });
    }
}

function analyzeWithClaude() {
    showAlert('Analyse IA en cours...', 'info');
    fetch(`/api/transactions/{{ transaction.id }}/claude-analyze/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Analyse IA terminée', 'success');
            // Mettre à jour le contenu sans recharger la page
            updateClaudeAnalysis(data);
        } else {
            showAlert('Erreur: ' + data.error, 'danger');
        }
    });
}

function updateClaudeAnalysis(data) {
    // Créer ou mettre à jour la section d'analyse Claude
    let analysisSection = document.querySelector('.claude-analysis-section');
    
    if (!analysisSection) {
        // Créer la section si elle n'existe pas
        analysisSection = document.createElement('div');
        analysisSection.className = 'detail-card claude-analysis-section';
        
        // Insérer après la section ML Analysis
        const mlSection = document.querySelector('.ml-analysis-section');
        if (mlSection) {
            mlSection.parentNode.insertBefore(analysisSection, mlSection.nextSibling);
        }
    }
    
    // Mettre à jour le contenu
    analysisSection.innerHTML = `
        <h5 class="mb-3">
            <i class="fas fa-brain text-primary"></i> 
            Analyse IA (Claude)
        </h5>
        
        <div class="alert alert-info border-0 mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <strong>Niveau de Priorité:</strong>
                <span class="badge bg-info">
                    ${data.priority || 'MEDIUM'}
                </span>
            </div>
            <p class="mb-0">${data.explanation || 'Analyse effectuée'}</p>
        </div>
        
        ${data.risk_factors && data.risk_factors.length > 0 ? `
        <div class="mb-3">
            <label class="form-label small text-muted">FACTEURS DE RISQUE IDENTIFIÉS</label>
            <div>
                ${data.risk_factors.map(factor => `<span class="badge bg-warning me-1 mb-1">${factor}</span>`).join('')}
            </div>
        </div>
        ` : ''}
        
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                <i class="fas fa-clock"></i> 
                Analysé à l'instant
            </small>
            <button class="btn btn-sm btn-outline-primary" onclick="reanalyzeTransaction()">
                <i class="fas fa-redo"></i> Réanalyser
            </button>
        </div>
    `;
}

function addNote(event) {
    event.preventDefault();
    const noteText = document.getElementById('noteText').value;
    const isFlagged = document.getElementById('flagTransaction').checked;
    
    if (!noteText.trim()) {
        showAlert('Veuillez saisir une note', 'warning');
        return;
    }
    
    fetch(`/api/transactions/{{ transaction.id }}/notes/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            note: noteText,
            is_flagged: isFlagged
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Note ajoutée', 'success');
            document.getElementById('noteForm').reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Erreur: ' + data.error, 'danger');
        }
    });
}

function exportTransaction() {
    window.location.href = `/api/transactions/{{ transaction.id }}/export/`;
}

function blockTransaction() {
    if (confirm('Bloquer cette transaction ?')) {
        fetch(`/api/transactions/{{ transaction.id }}/block/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Transaction bloquée', 'warning');
            } else {
                showAlert('Erreur: ' + data.error, 'danger');
            }
        });
    }
}

function approveTransaction() {
    if (confirm('Approuver cette transaction ?')) {
        fetch(`/api/transactions/{{ transaction.id }}/approve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Transaction approuvée', 'success');
            } else {
                showAlert('Erreur: ' + data.error, 'danger');
            }
        });
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>
{% endblock %}

