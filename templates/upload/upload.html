{% extends 'base/base.html' %}
{% load static %}

{% block title %}Import CSV - Banking Fraud Detection Platform{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-green: #10b981;
        --dark-green: #047857;
        --light-green: #ecfdf5;
        --accent-green: #34d399;
        
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        
        --blue-500: #3b82f6;
        --blue-600: #2563eb;
        
        --red-500: #ef4444;
        --red-100: #fee2e2;
        
        --yellow-500: #eab308;
        --yellow-100: #fef3c7;
        
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;
        
        --font-size-sm: 0.875rem;
        --font-size-base: 1rem;
        --font-size-lg: 1.125rem;
        --font-size-xl: 1.25rem;
        --font-size-2xl: 1.5rem;
        --font-size-3xl: 1.875rem;
        
        --border-radius: 0.5rem;
        --border-radius-lg: 0.75rem;
        --border-radius-xl: 1rem;
        
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    body {
        background: linear-gradient(135deg, var(--gray-50) 0%, var(--light-green) 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
    }

    .upload-container {
        max-width: 2000px;
        margin: 0 auto;
        padding: var(--spacing-xl);
    }

    .upload-header {
        text-align: center;
        margin-bottom: var(--spacing-2xl);
        animation: fadeInUp 0.8s ease-out;
    }

    .upload-title {
        font-size: var(--font-size-3xl);
        font-weight: 800;
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--blue-600) 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: var(--spacing-md);
        letter-spacing: -0.025em;
    }

    .upload-subtitle {
        color: var(--gray-600);
        font-size: var(--font-size-lg);
        font-weight: 500;
    }

    .upload-form {
        margin-bottom: var(--spacing-2xl);
        animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    .upload-area {
        position: relative;
        border: 3px dashed var(--gray-300);
        border-radius: var(--border-radius-xl);
        padding: var(--spacing-2xl);
        text-align: center;
        background: white;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        margin-bottom: var(--spacing-lg);
        overflow: hidden;
    }

    .upload-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
        transition: left 0.6s;
    }

    .upload-area:hover {
        border-color: var(--primary-green);
        background: var(--light-green);
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .upload-area:hover::before {
        left: 100%;
    }

    .upload-area.dragover {
        border-color: var(--primary-green);
        background: var(--light-green);
        transform: scale(1.02);
        box-shadow: var(--shadow-xl);
    }

    .upload-icon {
        font-size: 4rem;
        margin-bottom: var(--spacing-lg);
        animation: bounce 2s infinite;
    }

    .upload-text {
        font-size: var(--font-size-xl);
        color: var(--gray-700);
        margin-bottom: var(--spacing-md);
        font-weight: 600;
    }

    .upload-hint {
        font-size: var(--font-size-sm);
        color: var(--gray-500);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }

    .file-input {
        display: none;
    }

    .file-info {
        display: none;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        background: var(--gray-50);
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--gray-200);
    }

    .file-name {
        font-weight: 600;
        color: var(--primary-green);
    }

    .file-size {
        color: var(--gray-600);
        font-size: var(--font-size-sm);
        background: var(--gray-200);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius);
    }

    .btn-upload {
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
        color: white;
        padding: var(--spacing-lg) var(--spacing-2xl);
        border: none;
        border-radius: var(--border-radius-lg);
        font-size: var(--font-size-lg);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }

    .btn-upload::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s;
    }

    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-upload:hover::before {
        left: 100%;
    }

    .btn-upload:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .info-card {
        background: white;
        border-radius: var(--border-radius-xl);
        box-shadow: var(--shadow-md);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        border: 1px solid var(--gray-200);
        animation: fadeInUp 0.8s ease-out both;
    }

    .info-card:nth-child(4) { animation-delay: 0.4s; }
    .info-card:nth-child(5) { animation-delay: 0.6s; }

    .card-title {
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .card-icon {
        font-size: 1.5rem;
        padding: var(--spacing-sm);
        background: var(--light-green);
        border-radius: var(--border-radius);
    }

    .requirements-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: var(--spacing-md);
    }

    .requirements-list li {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--gray-50);
        border-radius: var(--border-radius-lg);
        border-left: 4px solid var(--primary-green);
        transition: all 0.3s ease;
    }

    .requirements-list li:hover {
        background: var(--light-green);
        transform: translateX(4px);
    }

    .requirement-icon {
        color: var(--primary-green);
        font-weight: bold;
        font-size: var(--font-size-lg);
        background: white;
        padding: var(--spacing-xs);
        border-radius: 50%;
        min-width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-sm);
    }

    .columns-section {
        margin-top: var(--spacing-xl);
    }

    .columns-section h3 {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .columns-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--spacing-md);
    }

    .column-item {
        background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
        padding: var(--spacing-md);
        border-radius: var(--border-radius-lg);
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: var(--font-size-sm);
        color: var(--gray-800);
        text-align: center;
        font-weight: 600;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .column-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-green);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .column-item:hover {
        background: var(--light-green);
        border-color: var(--primary-green);
        transform: translateY(-2px);
    }

    .column-item:hover::before {
        transform: scaleX(1);
    }

    .example-table {
        overflow-x: auto;
        background: var(--gray-50);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        border: 1px solid var(--gray-200);
    }

    .example-table table {
        width: 100%;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: var(--font-size-sm);
        border-collapse: collapse;
    }

    .example-table th,
    .example-table td {
        padding: var(--spacing-md) var(--spacing-sm);
        border: 1px solid var(--gray-300);
        text-align: left;
    }

    .example-table th {
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .example-table td {
        background: white;
        transition: background-color 0.2s ease;
    }

    .example-table tr:hover td {
        background: var(--light-green);
    }

    .transaction-types {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-radius: var(--border-radius-lg);
    }

    .transaction-types strong {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-base);
    }

    .file-selected {
        background: var(--light-green) !important;
        border-color: var(--primary-green) !important;
    }

    .file-selected .upload-icon {
        color: var(--primary-green);
    }

    .status-badges {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
        margin-top: var(--spacing-sm);
    }

    .status-badge {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius);
        font-size: var(--font-size-sm);
        font-weight: 500;
    }

    .status-ok { background: var(--light-green); color: var(--dark-green); }
    .status-ko { background: var(--red-100); color: var(--red-500); }
    .status-att { background: var(--yellow-100); color: var(--yellow-500); }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes bounce {
        0%, 20%, 53%, 80%, 100% {
            transform: translateY(0);
        }
        40%, 43% {
            transform: translateY(-10px);
        }
        70% {
            transform: translateY(-5px);
        }
        90% {
            transform: translateY(-2px);
        }
    }

    @media (max-width: 768px) {
        .upload-container {
            padding: var(--spacing-md);
        }
        
        .upload-area {
            padding: var(--spacing-xl);
        }
        
        .upload-title {
            font-size: var(--font-size-2xl);
        }
        
        .columns-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
        }
        
        .example-table {
            font-size: 0.75rem;
        }

        .upload-hint {
            flex-direction: column;
            gap: var(--spacing-xs);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="upload-header">
        <h1 class="upload-title">📤 Import de Données CSV</h1>
        <p class="upload-subtitle">
            Importez vos données de transactions pour analyse de fraude
        </p>
    </div>

    <form method="post" enctype="multipart/form-data" id="uploadForm" class="upload-form">
        {% csrf_token %}
        
        <div class="upload-area" onclick="document.getElementById('csv_file').click()">
            <div class="upload-icon">📁</div>
            <div class="upload-text">
                <strong>Cliquez pour sélectionner</strong> ou glissez-déposez votre fichier CSV
            </div>
            <div class="upload-hint">
                <span>📄 Fichiers CSV uniquement</span>
                <span>•</span>
                <span>📏 Taille max: 50MB</span>
            </div>
            <div class="file-info" id="fileInfo">
                <span class="file-name" id="fileName"></span>
                <span class="file-size" id="fileSize"></span>
            </div>
        </div>
        
        <input type="file" id="csv_file" name="csv_file" accept=".csv" class="file-input" required>
        
        <div style="text-align: center;">
          <input type="submit" value="🔍 Import" id="uploadBtn" class="btn btn-primary">
        </div>
    </form>

    <div class="info-card">
        <h2 class="card-title">
            <span class="card-icon">📋</span>
            Exigences du Fichier CSV
        </h2>
        
        <ul class="requirements-list">
            <li>
                <span class="requirement-icon">✓</span>
                <span>Format CSV avec séparateur virgule (,)</span>
            </li>
            <li>
                <span class="requirement-icon">✓</span>
                <span>Encodage UTF-8 recommandé</span>
            </li>
            <li>
                <span class="requirement-icon">✓</span>
                <span>Première ligne contenant les en-têtes</span>
            </li>
            <li>
                <span class="requirement-icon">✓</span>
                <span>Toutes les colonnes obligatoires présentes</span>
            </li>
        </ul>
        
        <div class="columns-section">
            <h3>
                <span>📊</span>
                Colonnes Obligatoires
            </h3>
            
            <div class="columns-grid">
                <div class="column-item">TRX</div>
                <div class="column-item">TRX_TIME</div>
                <div class="column-item">mls</div>
                <div class="column-item">TRX_TYPE</div>
                <div class="column-item">MONTANT</div>
                <div class="column-item">CLIENT_I</div>
                <div class="column-item">CLIENT_B</div>
                <div class="column-item">BANK_I</div>
                <div class="column-item">BANK_B</div>
                <div class="column-item">ETAT</div>
            </div>
        </div>
    </div>

    <div class="info-card">
        <h2 class="card-title">
            <span class="card-icon">📄</span>
            Exemple de Format CSV
        </h2>
        
        <div class="example-table">
            <table>
                <thead>
                    <tr>
                        <th>TRX</th>
                        <th>TRX_TIME</th>
                        <th>mls</th>
                        <th>TRX_TYPE</th>
                        <th>MONTANT</th>
                        <th>CLIENT_I</th>
                        <th>CLIENT_B</th>
                        <th>BANK_I</th>
                        <th>BANK_B</th>
                        <th>ETAT</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>TXN001</td>
                        <td>2024-01-15 14:30:25</td>
                        <td>1705327825000</td>
                        <td>TRF</td>
                        <td>1500.00</td>
                        <td>CLI000001</td>
                        <td>CLI000002</td>
                        <td>BNK001</td>
                        <td>BNK002</td>
                        <td>OK</td>
                    </tr>
                    <tr>
                        <td>TXN002</td>
                        <td>2024-01-15 15:45:12</td>
                        <td>1705332312000</td>
                        <td>RT</td>
                        <td>500.00</td>
                        <td>CLI000003</td>
                        <td>CLI000003</td>
                        <td>BNK001</td>
                        <td>BNK001</td>
                        <td>OK</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="transaction-types">
            <strong>📋 Types de transaction:</strong>
            <div class="status-badges">
                <span class="status-badge" style="background: var(--light-green); color: var(--dark-green);">TRF - Transfert</span>
                <span class="status-badge" style="background: var(--blue-500); color: white;">RT - Retrait</span>
                <span class="status-badge" style="background: var(--yellow-100); color: var(--yellow-500);">RCD - Recharge</span>
                <span class="status-badge" style="background: var(--gray-200); color: var(--gray-700);">PF - Paiement</span>
            </div>
            <br>
            <strong>🚦 États possibles:</strong>
            <div class="status-badges">
                <span class="status-badge status-ok">OK - Réussie</span>
                <span class="status-badge status-ko">KO - Échec</span>
                <span class="status-badge status-att">ATT - En attente</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('csv_file');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        // Drag & Drop handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    fileInput.files = files;
                    updateFileDisplay(file);
                } else {
                    alert('Veuillez sélectionner un fichier CSV valide.');
                }
            }
        }

        // File input change handler
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                updateFileDisplay(e.target.files[0]);
            }
        });

        function updateFileDisplay(file) {
            uploadArea.classList.add('file-selected');
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'flex';
            uploadBtn.disabled = false;
            
            // Mettre à jour le texte de la zone d'upload
            const uploadText = uploadArea.querySelector('.upload-text');
            uploadText.innerHTML = '<strong>✅ Fichier sélectionné avec succès</strong>';
            
            // Mettre à jour l'icône
            const uploadIcon = uploadArea.querySelector('.upload-icon');
            uploadIcon.textContent = '✅';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Veuillez sélectionner un fichier CSV.');
                return;
            }

            // Désactiver le bouton pour éviter les doubles soumissions
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '⏳ Import en cours...';
        });

        // Animate column items on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animationDelay = Math.random() * 0.5 + 's';
                    entry.target.style.animation = 'fadeInUp 0.6s ease-out both';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.column-item').forEach(item => {
            observer.observe(item);
        });
    });
</script>
{% endblock %}